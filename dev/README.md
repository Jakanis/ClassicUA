# ClassicUA Generator Scripts

This folder contains development scripts, which are used to generate lua files (content of "entries" folder). Some files are edited manually (via pull requests), such files has no "autogenerated" header comment.

## Next release making steps

1. Download all files from Crowdin:
    - Export terms in TBX (v2) format -> ClassicUA.tbx
    - Export quests via "Build & Download" -> ClassicUA.zip
    - Download source for following folders:
        - chats, chats_*
        - gossip, gossip_*
        Note: select multiple folders, right click and choose "Download sources" -> ClassicUA_en.zip

2. Update Terms app:
    - Update file /docs/terms/ClassicUA.tbx
    - Update the date in /docs/terms/index.html
    - Commit "Update terms"

3. Generate lua files:
    - Clean up folder "translation_from_crowdin"
    - Copy ClassicUA.tbx, ClassicUA.zip and ClassicUA_en.zip, extract both zips
    - Expected structure at this point:
        * /uk                   <- from ClassicUA.zip
        * /en                   <- from ClassicUA_en.zip
        *   /chats, /chats_*
        *   /gossip, gossip_*
        * /ClassicUA.tbx

    - Run python gen_book_lua.py > translation_from_crowdin/gen_book_lua_output.txt
    - Run python gen_chat_lua.py > translation_from_crowdin/gen_chat_lua_output.txt
    - Run python gen_gossip_lua.py > translation_from_crowdin/gen_gossip_lua_output.txt
    - Run python gen_misc_lua.py > translation_from_crowdin/gen_misc_lua_output.txt
    - Run python gen_npc_lua.py > translation_from_crowdin/gen_npc_lua_output.txt
    - Run python gen_quest_lua.py > translation_from_crowdin/gen_quest_lua_output.txt
    - Run python gen_zone_lua.py > translation_from_crowdin/gen_zone_lua_output.txt

    - Run lua54 gen_stat_count_lua.lua > translation_from_crowdin/gen_stat_count_lua_output.txt
        Note: this script must go last, it collects stats based on all current lua files in ./entries
        (autogenerated and manually edited)

    - Commit "Sync from Crowdin"

4. Update and release new version
    - Commit "Update Classic API to X.X.X and Cata to X.X.X" if needed
    - Commit "Update changelog" with updated "changelog" in info.lua
    - Commit "Bump version to X.X" with updated TOC files
    - Create new version archive "ClassicUA-vX.X.zip"
    - Upload the archive to CurseForge and wait until approved

## Taint

`@taint`

We mark "@taint" places which are disabled as they cause ui to stop working.

More at:
- https://wowpedia.fandom.com/wiki/Secure_Execution_and_Tainting
- https://wowpedia.fandom.com/wiki/Category:API_functions/restricted

Known so far:
- global strings:
    - changing strings from context menu of unit frame blocks the actions "Copy Character Name" and "Set Focus"
    - changing GENERAL_SPELLS (and potentially other strings in Spell Book) blocks its opening in combat
- global functions:
    - changing C_GossipInfo.GetOptions blocks gossip from opening in combat
    - changing ItemTextGetText or ItemTextGetItem blocks book from opening in combat

Target dummy can be used for easy getting into combat and testing if ui working properly when making changes.

PS.: maybe we should consider option for a player like "Allow Combat-Secured Translation" and explain in the tooltip so player knows what it means, basically player can choose to see maximum translated ui and agrees to have some "failed" messages in chat and "blocked" messages in popups when in combat.
